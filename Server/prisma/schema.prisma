// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  student
  teacher
  parent
  direction
}

enum Gender {
  male
  female
}

enum StudentStatus {
  active
  inactive
  suspended
  graduated
}

enum TeacherStatus {
  active
  inactive
  on_leave
}

enum ParentStatus {
  active
  inactive
}

enum Semester {
  S1
  S2
  Summer
}

enum ExamType {
  quiz
  midterm
  final
  assignment
  project
  practical
}

enum GradeLetter {
  A_PLUS
  A
  B_PLUS
  B
  C_PLUS
  C
  D
  F
}

enum AttendanceStatus {
  present
  absent
  late
  excused
}

enum AssignmentStatus {
  active
  closed
  draft
}

enum PaymentType {
  tuition
  transport
  library
  sports
  exam
  hostel
  other
}

enum PaymentStatus {
  pending
  paid
  overdue
  cancelled
  refunded
}

enum PaymentMethod {
  cash
  card
  bank_transfer
  cheque
  online
}

enum EventType {
  academic
  sports
  cultural
  holiday
  exam
  meeting
  other
}

enum EventStatus {
  scheduled
  ongoing
  completed
  cancelled
}

enum EventTargetAudience {
  all
  students
  teachers
  parents
  staff
}

enum MessagePriority {
  low
  normal
  high
}

enum MessageCategory {
  academic
  administrative
  general
  urgent
}

enum Relationship {
  father
  mother
  guardian
}

enum MealType {
  breakfast
  lunch
  snack
  dinner
}

enum CantineStatus {
  pending
  confirmed
  served
  cancelled
}

model User {
  id        Int      @id @default(autoincrement())
  firstName String   @db.VarChar(50)
  lastName  String   @db.VarChar(50)
  email     String   @unique
  password  String
  role      Role     @default(student)
  avatar    String?  @default("https://via.placeholder.com/150")
  phone     String?
  isActive  Boolean  @default(true)
  lastLogin DateTime? @map("last_login")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  refreshTokens    RefreshToken[]
  studentProfile    Student?
  teacherProfile    Teacher?
  parentProfile     Parent?
  organizedEvents   Event[]      @relation("EventOrganizer")
  sentMessages      Message[]     @relation("MessageSender")
  receivedMessages  Message[]     @relation("MessageRecipient")

  @@map("users")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Student {
  id                            Int            @id @default(autoincrement())
  userId                        Int            @unique @map("user_id")
  matricule                     String         @unique
  dateOfBirth                   DateTime       @map("date_of_birth")
  gender                        Gender
  addressStreet                 String?        @map("address_street")
  addressCity                   String?        @map("address_city")
  addressState                  String?        @map("address_state")
  addressZipCode                String?        @map("address_zip_code")
  addressCountry                String?        @map("address_country")
  level                         String
  className                     String         @map("class_name")
  section                       String?
  admissionDate                 DateTime       @default(now()) @map("admission_date")
  status                        StudentStatus  @default(active)
  parentId                      Int?           @map("parent_id")
  bloodGroup                    String?        @map("blood_group")
  allergies                     Json?          @default("[]")
  medicalConditions             Json?          @map("medical_conditions") @default("[]")
  emergencyContactName          String?        @map("emergency_contact_name")
  emergencyContactRelationship  String?        @map("emergency_contact_relationship")
  emergencyContactPhone         String?        @map("emergency_contact_phone")
  previousSchoolName            String?        @map("previous_school_name")
  previousSchoolYear            String?        @map("previous_school_year")
  documents                     Json?          @default("[]")
  createdAt                     DateTime       @default(now()) @map("created_at")
  updatedAt                     DateTime       @updatedAt @map("updated_at")

  // Relations
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Parent?     @relation(fields: [parentId], references: [id])
  grades    Grade[]
  attendances Attendance[]
  payments  Payment[]
  cantines  Cantine[]

  @@map("students")
}

model Teacher {
  id              Int           @id @default(autoincrement())
  userId          Int           @unique @map("user_id")
  employeeId      String        @unique @map("employee_id")
  dateOfBirth     DateTime      @map("date_of_birth")
  gender          Gender
  addressStreet   String?       @map("address_street")
  addressCity     String?       @map("address_city")
  addressState    String?       @map("address_state")
  addressZipCode  String?       @map("address_zip_code")
  addressCountry  String?       @map("address_country")
  qualification   String
  specialization  String
  subjects        Json?         @default("[]")
  experience      Int           @default(0)
  joiningDate     DateTime      @default(now()) @map("joining_date")
  salary          Decimal       @db.Decimal(10, 2)
  status          TeacherStatus @default(active)
  classes         Json?         @default("[]")
  schedule        Json?         @default("[]")
  documents       Json?         @default("[]")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses     Course[]
  grades      Grade[]
  assignments Assignment[]
  attendances Attendance[]

  @@map("teachers")
}

model Parent {
  id                         Int           @id @default(autoincrement())
  userId                     Int           @unique @map("user_id")
  relationship               Relationship
  occupation                 String?
  addressStreet              String?       @map("address_street")
  addressCity                String?       @map("address_city")
  addressState               String?       @map("address_state")
  addressZipCode             String?       @map("address_zip_code")
  addressCountry             String?       @map("address_country")
  emergencyContactName       String?       @map("emergency_contact_name")
  emergencyContactRelationship String?     @map("emergency_contact_relationship")
  emergencyContactPhone      String?       @map("emergency_contact_phone")
  status                     ParentStatus  @default(active)
  createdAt                  DateTime      @default(now()) @map("created_at")
  updatedAt                  DateTime      @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  children Student[]

  @@map("parents")
}

model Course {
  id              Int       @id @default(autoincrement())
  name            String
  code            String    @unique
  description     String?   @db.Text
  level           String
  subject         String
  teacherId       Int?      @map("teacher_id")
  credits         Int       @default(1)
  maxStudents     Int       @default(30) @map("max_students")
  enrolledStudents Json?    @map("enrolled_students") @default("[]")
  schedule        Json?     @default("[]")
  syllabus        Json?     @default("[]")
  status          String    @default("active") // active, inactive, completed
  academicYear    String    @map("academic_year")
  semester        Semester
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  teacher     Teacher?  @relation(fields: [teacherId], references: [id])
  grades      Grade[]
  assignments Assignment[]
  attendances Attendance[]

  @@map("courses")
}

model Grade {
  id           Int        @id @default(autoincrement())
  studentId    Int        @map("student_id")
  courseId     Int        @map("course_id")
  examType     ExamType   @map("exam_type")
  subject      String
  marks        Decimal    @db.Decimal(10, 2)
  totalMarks   Decimal    @map("total_marks") @db.Decimal(10, 2)
  percentage   Decimal?   @db.Decimal(5, 2)
  grade        GradeLetter?
  remarks      String?    @db.Text
  teacherId    Int        @map("teacher_id")
  academicYear String     @map("academic_year")
  semester     Semester
  examDate     DateTime   @map("exam_date")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id])

  @@map("grades")
}

model Assignment {
  id          Int             @id @default(autoincrement())
  title       String
  description String          @db.Text
  courseId    Int             @map("course_id")
  teacherId   Int             @map("teacher_id")
  subject     String
  level       String
  className   String          @map("class_name")
  dueDate     DateTime        @map("due_date")
  totalMarks  Decimal         @map("total_marks") @db.Decimal(10, 2)
  attachments Json?           @default("[]")
  submissions Json?           @default("[]")
  status      AssignmentStatus @default(active)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id])

  @@map("assignments")
}

model Attendance {
  id           Int             @id @default(autoincrement())
  studentId    Int             @map("student_id")
  courseId     Int?            @map("course_id")
  date         DateTime        @default(now())
  status       AttendanceStatus
  subject      String?
  teacherId    Int?            @map("teacher_id")
  remarks      String?         @db.Text
  academicYear String          @map("academic_year")
  semester     Semester
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  student Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id])
  teacher Teacher? @relation(fields: [teacherId], references: [id])

  @@unique([studentId, date, courseId])
  @@map("attendances")
}

model Payment {
  id            Int           @id @default(autoincrement())
  studentId     Int           @map("student_id")
  type          PaymentType
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("USD") @db.VarChar(3)
  status        PaymentStatus @default(pending)
  dueDate       DateTime      @map("due_date")
  paidDate      DateTime?     @map("paid_date")
  paymentMethod PaymentMethod? @map("payment_method")
  transactionId String?       @map("transaction_id")
  remarks       String?       @db.Text
  academicYear  String        @map("academic_year")
  semester      Semester?
  receiptNumber String?       @unique @map("receipt_number")
  invoiceUrl    String?       @map("invoice_url")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Event {
  id              Int                @id @default(autoincrement())
  title           String
  description     String?            @db.Text
  type            EventType
  startDate       DateTime           @map("start_date")
  endDate         DateTime           @map("end_date")
  location        String?
  organizerId     Int?               @map("organizer_id")
  participants    Json?              @default("[]")
  targetAudience  EventTargetAudience @default(all) @map("target_audience")
  levels          Json?              @default("[]")
  status          EventStatus        @default(scheduled)
  isPublic        Boolean            @default(true) @map("is_public")
  attachments     Json?              @default("[]")
  maxParticipants Int?               @map("max_participants")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  organizer User? @relation("EventOrganizer", fields: [organizerId], references: [id])

  @@map("events")
}

model Message {
  id          Int            @id @default(autoincrement())
  senderId    Int            @map("sender_id")
  recipientId Int            @map("recipient_id")
  subject     String
  content     String         @db.Text
  attachments Json?          @default("[]")
  isRead      Boolean        @default(false) @map("is_read")
  readAt      DateTime?      @map("read_at")
  priority    MessagePriority @default(normal)
  category    MessageCategory @default(general)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Relations
  sender    User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient User @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Cantine {
  id                Int           @id @default(autoincrement())
  studentId         Int           @map("student_id")
  date              DateTime      @default(now())
  mealType          MealType      @map("meal_type")
  items             Json
  totalAmount       Decimal       @map("total_amount") @db.Decimal(10, 2)
  status            CantineStatus @default(pending)
  paymentStatus     String        @default("pending") @map("payment_status") // pending, paid
  specialInstructions String?     @map("special_instructions") @db.Text
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("cantines")
}
